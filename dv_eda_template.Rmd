---
title: "eda_template"
author: ""
date: "5/3/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory Analysis

```{r}
# Load the required packages
library(ggplot2)
# library(caret)
library(e1071)
library(dplyr)
library(plyr)
library(readr)
library(boot)
library(car)
# library(DataExplorer)
library(knitr)
library(MASS)


# Load the stats and vis functions
source("https://raw.githubusercontent.com/datafeelings/CUNY_DATA_621_SS2018_Final/master/2_code/Graphical_Functions.R")
source("https://raw.githubusercontent.com/datafeelings/CUNY_DATA_621_SS2018_Final/master/2_code/stats_function.R")

```

```{r cache=T}
# Load the full data

inp = read_csv("https://raw.githubusercontent.com/datafeelings/CUNY_DATA_621_SS2018_Final/master/0_raw_data/bcn_listings.csv.gz")
inp = data.frame(inp)
```

```{r}
# Variable subset and preprocess

inp = subset(inp, select = c(price,review_scores_communication,review_scores_location,review_scores_value,requires_license,instant_bookable,is_business_travel_ready,cancellation_policy,require_guest_profile_picture,require_guest_phone_verification,calculated_host_listings_count,reviews_per_month,neighbourhood_cleansed,zipcode,neighbourhood_group_cleansed))

# Changing factors to int char
inp$price = as.numeric(gsub("[\\$,]", "", inp$price))


```

## Variable overview


### review_scores_communication
  
#### Distribution
  
```{r}
kable(stats(data.frame(inp$review_scores_communication)))
```

#### Relative frequency

```{r}

table(inp$review_scores_communication, useNA = "always")

```


```{r}
tmp = "review_scores_communication"

bar621(inp, factor(review_scores_communication),
       xlab=tmp,
       title=paste("Frequency of levels of",tmp)) + ylim(c(0,10050))
```

#### Transformation

All scores below 8 are merged into a single group.
  
```{r}
inp = as.tbl(inp)

inp = inp %>% mutate(review_scores_communication_bin = case_when(
  review_scores_communication <  8 ~ "< 8",
  review_scores_communication >=  8 ~ as.character(review_scores_communication))
  ) 

```
  
#### Relationship to Price  
  
```{r}
box621(inp, review_scores_communication_bin, log(price))

```  

### review_scores_location
  
#### Distribution
  
```{r}
kable(stats(data.frame(inp$review_scores_location)))
```

#### Relative frequency

```{r}

table(inp$review_scores_communication, useNA = "always")

```


```{r}
tmp = "review_scores_location"

bar621(inp, factor(review_scores_location),
       xlab=tmp,
       title=paste("Frequency of levels of",tmp)) + ylim(c(0,10050))
```

#### Transformation

All scores below 8 are merged into a single group.
  
```{r}
inp = as.tbl(inp)

inp = inp %>% mutate(review_scores_location_bin = case_when(
  review_scores_location <  8 ~ "< 8",
  review_scores_location >=  8 ~ as.character(review_scores_location))
  ) 

```
  
#### Relationship to Price  
  
```{r}
box621(inp, review_scores_location_bin, log(price))

```  

### review_scores_value
  
#### Distribution
  
```{r}
kable(stats(data.frame(inp$review_scores_value)))
```

#### Relative frequency

```{r}

table(inp$review_scores_value, useNA = "always")

```


```{r}
tmp = "review_scores_value"

bar621(inp, factor(review_scores_value),
       xlab=tmp,
       title=paste("Frequency of levels of",tmp)) + ylim(c(0,10050))
```

#### Transformation

All scores below 8 are merged into a single group.
  
```{r}
inp = as.tbl(inp)

inp = inp %>% mutate(review_scores_value_bin = case_when(
  review_scores_value <  8 ~ "< 8",
  review_scores_value >=  8 ~ as.character(review_scores_value))
  ) 

```
  
#### Relationship to Price  
  
```{r}
box621(inp, review_scores_value_bin, log(price))

``` 

### requires_license

Variable excluded as all observations have the same value.
  
  
### instant_bookable
    
This is a factor with two levels: true ("t") and false ("f")
  
#### Distribution
  
```{r}
kable(table(inp$instant_bookable,dnn = "instant_bookable"))
```

#### Relative frequency

```{r}
tmp = "instant_bookable"
bar621(df=inp, instant_bookable, xlab="", title=paste("Frequency of levels of",tmp)) + ylim(c(0,11000))
```

#### Relationship to Price  
  
```{r}
box621(inp, instant_bookable, log(price))

``` 

### is_business_travel_ready
    
This is a factor with two levels: true ("t") and false ("f")
  
#### Distribution
  
```{r}
kable(table(inp$is_business_travel_ready,dnn = "is_business_travel_ready"))
```

#### Relative frequency

```{r}
tmp = "is_business_travel_ready"
bar621(df=inp, is_business_travel_ready, xlab="", title=paste("Frequency of levels of",tmp)) + ylim(c(0,19000))
```

#### Relationship to Price  
  
```{r}
box621(inp, is_business_travel_ready, log(price))

``` 

### cancellation_policy
    
This is a factor with five levels corresponding to cancellation policy types.
  
#### Distribution
  
```{r}
kable(table(inp$cancellation_policy,dnn = "cancellation_policy"))
```

#### Relative frequency


```{r}
tmp = "cancellation_policy"

bar621(inp, factor(cancellation_policy),
       xlab=tmp,
       title=paste("Frequency of levels of",tmp)) + ylim(c(0,10050))
```

#### Transformation

All scores below 8 are merged into a single group.
  
```{r}
inp = as.tbl(inp)

inp = inp %>% mutate(cancellation_policy_bin = ifelse(
  grepl("strict", cancellation_policy, fixed = TRUE),  "strict", cancellation_policy)
  ) 

```
  
#### Relationship to Price  
  
```{r}
box621(inp, cancellation_policy_bin, log(price))

``` 


### require_guest_profile_picture
    
This is a factor with two levels: true ("t") and false ("f")
  
#### Distribution
  
```{r}
kable(table(inp$require_guest_profile_picture,dnn = "require_guest_profile_picture"))
```

#### Relative frequency

```{r}
tmp = "require_guest_profile_picture"
bar621(df=inp, require_guest_profile_picture, xlab="", title=paste("Frequency of levels of",tmp)) + ylim(c(0,19000))
```

#### Relationship to Price  
  
```{r}
box621(inp, require_guest_profile_picture, log(price))

``` 


### require_guest_phone_verification
    
This is a factor with two levels: true ("t") and false ("f")
  
#### Distribution
  
```{r}
kable(table(inp$require_guest_phone_verification,dnn = "require_guest_phone_verification"))
```

#### Relative frequency

```{r}
tmp = "require_guest_phone_verification"
bar621(df=inp, require_guest_phone_verification, xlab="", title=paste("Frequency of levels of",tmp)) + ylim(c(0,19000))
```

#### Relationship to Price  
  
```{r}
box621(inp, require_guest_phone_verification, log(price))

```

### calculated_host_listings_count
    
  
#### Distribution
  
```{r}
kable(stats(data.frame(inp$calculated_host_listings_count)))
```

#### Histogram

```{r}
tmp = "calculated_host_listings_count"
hist621(df=inp, calculated_host_listings_count)
```

#### Box-Cox  
  
```{r}
boxcoxfit(inp$calculated_host_listings_count[!is.na(inp$calculated_host_listings_count)])

```
  
#### Relationship to Price  
  
```{r}
scat621(inp %>% sample_n(5000), calculated_host_listings_count^(-0.6), log(price))

```  

### reviews_per_month
    
#### Distribution
  
```{r}
kable(stats(data.frame(inp$reviews_per_month)))
```

#### Histogram

```{r}
tmp = "reviews_per_month"
hist621(df=inp, reviews_per_month)
```

#### Box-Cox  
  
```{r}
boxcoxfit(inp$reviews_per_month[!is.na(inp$reviews_per_month)])

```
  
#### Relationship to Price  
  
```{r}
scat621(inp %>% sample_n(5000), reviews_per_month^(0.2), log(price))

```  

### neighbourhood_cleansed
    
This is a factor with two 72 levels correspondent to the neighborhoods of Barcelona. Will not be considered further as data on districts the neighborhoods belong to is available (see below).
  
#### Distribution
  
```{r}
str(data.frame(inp$neighbourhood_cleansed))
```
  

### neighbourhood_group_cleansed
    
This is a factor with ten levels correspondent to the ten districts of the city (location of the listing).
  
#### Distribution
  
```{r}
kable(table(inp$neighbourhood_group_cleansed,dnn = "neighbourhood_group_cleansed"))
```

#### Relative frequency

```{r}
tmp = "neighbourhood_group_cleansed"
bar621(df=inp, neighbourhood_group_cleansed, xlab="", title=paste("Frequency of levels of",tmp)) + ylim(c(0,10000))
```

#### Relationship to Price  
  
```{r}
box621(inp, neighbourhood_group_cleansed, log(price))

```
